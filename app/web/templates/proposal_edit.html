{% extends "layout.html" %}
{% block content %}
<div class="toolbar">
  <div class="left">
    <span class="kp-head">КП {{ p.number }} — {{ p.title }}</span>
  </div>
  <div class="right">
    <button onclick="saveKP()">Сохранить</button>
    <a class="btn" target="_blank" href="/proposals/{{ p.id }}/print">Печать</a>
    <a class="btn" target="_blank" href="/proposals/{{ p.id }}/pdf">В PDF</a>
    <a class="btn" href="/contract/editor?customer_id={{ p.customer_id }}&kp_id={{ p.id }}">Редактор договора</a>
  </div>
</div>

<div class="card">
  <h3>Шапка КП</h3>
  <div class="grid2">
    <label>Название:</label><input id="title" value="{{ p.title }}">
    <label>Адрес объекта:</label><input id="site_address" value="{{ p.site_address or (p.customer.address_object if p.customer else '') }}" placeholder="Адрес объекта">
    <label>Бренд/шапка (HTML):</label><textarea id="header_html" rows="3" placeholder="<b>VENT•PRO HVAC</b>">{{ p.header_html or "<b>VENT•PRO HVAC</b>" }}</textarea>
  </div>
</div>

<div class="card">
  <h3>Разделы и позиции (Excel-стиль)</h3>
  <form onsubmit="return addSection()">
    <input id="sec-title" placeholder="Название раздела">
    <button>Добавить раздел</button>
  </form>
  <div id="sections">
    {% for s in sections %}
      <div class="section" data-id="{{ s.id }}">
        <h4>{{ s.position }}. {{ s.title }}</h4>
        <form onsubmit="return addItem({{ s.id }})">
          <input name="name" placeholder="Наименование и тех. характеристика" style="width:26%">
          <input name="note" placeholder="Тип, марка, обозначение" style="width:22%">
          <input name="unit" value="шт" style="width:60px">
          <input name="qty" value="1" style="width:80px">
          <input name="price" value="0" style="width:120px" title="Цена материалов за ед.">
          <input name="price_labor" value="0" style="width:140px" title="Цена монтажа за ед.">
          <button>Добавить позицию</button>
        </form>
        <table class="items" id="items-{{ s.id }}">
          <tr>
            <th>Поз.</th><th>Наименование</th><th>Тип, марка</th><th>Ед.</th><th>Кол-во</th>
            <th>Цена (мат.)</th><th>Мат. всего</th><th>Цена (монтаж)</th><th>Монтаж всего</th><th>Итого</th>
          </tr>
          {% for i in items if i.section_id == s.id %}
            {% set m_total = (i.qty or 0)*(i.price or 0) %}
            {% set l_total = (i.qty or 0)*(i.price_labor or 0) %}
            <tr>
              <td>{{ i.position or "" }}</td>
              <td>{{ i.name }}</td>
              <td>{{ i.note or "" }}</td>
              <td>{{ i.unit }}</td>
              <td>{{ i.qty }}</td>
              <td>{{ "%.0f" % (i.price or 0) }}</td>
              <td>{{ "%.0f" % m_total }}</td>
              <td>{{ "%.0f" % (i.price_labor or 0) }}</td>
              <td>{{ "%.0f" % l_total }}</td>
              <td>{{ "%.0f" % (m_total + l_total) }}</td>
            </tr>
          {% endfor %}
        </table>
      </div>
    {% endfor %}
  </div>
</div>

<script>
async function saveKP(){
  const payload = {
    title: document.getElementById('title').value,
    site_address: document.getElementById('site_address').value,
    header_html: document.getElementById('header_html').value,
  };
  await fetch('/proposals/{{ p.id }}/save', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  alert('Сохранено');
}
async function addSection(){
  const title = document.getElementById('sec-title').value.trim();
  if(!title) return false;
  const r = await fetch('/api/v1/proposals/sections', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({proposal_id: {{ p.id }}, title})});
  if(r.ok) location.reload(); else alert('Ошибка');
  return false;
}
async function addItem(secId){
  const form = event.target;
  const payload = {
    proposal_id: {{ p.id }},
    section_id: secId,
    name: form.querySelector('[name=name]').value,
    note: form.querySelector('[name=note]').value,
    unit: form.querySelector('[name=unit]').value,
    qty: parseFloat(form.querySelector('[name=qty]').value||'1'),
    price: parseFloat(form.querySelector('[name=price]').value||'0'),
    price_labor: parseFloat(form.querySelector('[name=price_labor]').value||'0')
  };
  const r = await fetch('/api/v1/proposals/items', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  if(r.ok) location.reload(); else alert('Ошибка');
  return false;
}
</script>
{% endblock %}
